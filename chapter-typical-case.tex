%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%                      %%%%%
%%%%%   The Typical Case   %%%%%
%%%%%                      %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Typical Case}
\label{chap_typical_case}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%                     %%%%%
%%%%%   Addition Matrix   %%%%%
%%%%%                     %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Constructing the Matrix $M_{\text{add}}$.}

We wish to add two type 31 divisors $D$ and $D'$,
given by ideals $I_D = \pid{f,g,h}$ and $I_{D'} = \pid{f',g',h'}$, where
\begin{align*}
  f &= x^2 + f_2y + f_1x + f_0 & f' &= x^2 + f'_2y + f'_1x + f'_0 \\
  g &=  xy + g_2y + g_1x + g_0 & g' &=  xy + g'_2y + g'_1x + g'_0 \\
  h &= y^2 + h_2y + h_1x + h_0 & h' &= y^2 + h'_2y + h'_1x + h'_0.
\end{align*}
We will not assume that $D$ or $D'$ are typical,
though this algorithm will fail if their sum is atypical.

We construct the matrix 
\[ M_{\text{add}} =
\begin{pmatrix}
  a_1 & a_2 & a_3 & a_4 & a_5 \\
  a_6 & a_7 & a_8 & a_9 & a_{10} \\
  a_{11} & a_{12} & a_{13} & a_{14} & a_{15}
\end{pmatrix}. \]
The first three columns are simply the reductions of $f$, $g$, and $h$ modulo $f'$, $g'$, and $h'$, respectively.
\begin{align*}
  a_1    &= f_0 - f'_0 & a_2    &= g_0 - g'_0 & a_3    &= h_0 - h'_0 \\
  a_6    &= f_1 - f'_1 & a_7    &= g_1 - g'_1 & a_8    &= h_1 - h'_1 \\
  a_{11} &= f_2 - f'_2 & a_{12} &= g_2 - g'_2 & a_{13} &= h_2 - h'_2.
\end{align*}

\[ 
  \begin{pmatrix}
    a_4    & a_5    \\
    a_9    & a_{10} \\
    a_{14} & a_{15}
  \end{pmatrix} = 
  \begin{pmatrix}
    0 & -f'_0 & -g'_0 \\
    1 & -f'_1 & -g'_1 \\
    0 & -f'_2 & -g'_2
  \end{pmatrix}
  \begin{pmatrix}
    a_1    & a_2    \\
    a_6    & a_7    \\
    a_{11} & a_{12}
  \end{pmatrix}.
\]

\begin{align*}
  a_4    &=     - f'_0a_6 - g'_0a_{11} & a_5    &=     - f'_0a_7 - g'_0a_{12} \\
  a_9    &= a_1 - f'_1a_6 - g'_1a_{11} & a_{10} &= a_2 - f'_1a_7 - g'_1a_{12} \\
  a_{14} &=     - f'_2a_6 - g'_2a_{11} & a_{15} &=     - f'_2a_7 - g'_2a_{12}.
\end{align*}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%                     %%%%%
%%%%%   Doubling Matrix   %%%%%
%%%%%                     %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Constructing the Matrix $M_{\text{doub}}$.}

Assume that $f_2 \neq 0$.
We must find $g', h'$ such that $fh' \equiv gg'$
Assuming $1/f_2$ is known,
\begin{align*}
  g' &= xy            + g'_2y + g'_1x + g'_0 \\
  h' &= y^2 + h'_3x^2 + h'_2y + h'_1x + h'_0
\end{align*}
where
\begin{align*}
  h'_3 &= f_2 \\
  g'_2 &= - c_8f_2 + f_1 - g_2 \\
  h'_2 &= c_5 + (g'_2g_2 - f_0)/f_2 \\ 
  g'_1 &= f_2(f_2 - c_7) + h'_2 - g_1 \\
  h'_1 &= f_2(c_6 - f_1) \\
  g'_0 &= h'_2f_1 + h'_1f_2 - c_4f_2 - g'_2g_1 - g'_1g_2 - g_0 \\
  h'_0 &= -f_0f_2 - h'_1f_1 - c_3f_2 - g'_1g_1
\end{align*}

\[ M_{\text{doub}} =
\begin{pmatrix}
  a_1 & a_2 & a_3 & a_4 & a_5 \\
  a_6 & a_7 & a_8 & a_9 & a_{10} \\
  a_{11} & a_{12} & a_{13} & a_{14} & a_{15}
\end{pmatrix}. \]
\begin{align*}
  a_1    &= g'_0 - g_0 & a_2    &= h'_0 - h_0 - h'_3f_0 \\
  a_6    &= g'_1 - g_1 & a_7    &= h'_1 - h_1 - h'_3f_1 \\
  a_{11} &= g'_2 - g_2 & a_{12} &= h'_2 - h_2 - h'_3f_2 \\
\end{align*}

\[ 
  \begin{pmatrix}
    a_4    & a_5    \\
    a_9    & a_{10} \\
    a_{14} & a_{15}
  \end{pmatrix} = 
  \begin{pmatrix}
    0 & -f'_0 & -g'_0 \\
    1 & -f'_1 & -g'_1 \\
    0 & -f'_2 & -g'_2
  \end{pmatrix}
  \begin{pmatrix}
    a_1    & a_2    \\
    a_6    & a_7    \\
    a_{11} & a_{12}
  \end{pmatrix}.
\]

\begin{align*}
  a_4    &=     - f'_0a_6 - g'_0a_{11} & a_5    &=     - f'_0a_7 - g'_0a_{12} \\
  a_9    &= a_1 - f'_1a_6 - g'_1a_{11} & a_{10} &= a_2 - f'_1a_7 - g'_1a_{12} \\
  a_{14} &=     - f'_2a_6 - g'_2a_{11} & a_{15} &=     - f'_2a_7 - g'_2a_{12}.
\end{align*}

Column 3 is computed by
\begin{align*}
  C_3 &= \frac 1 {f_2} \left( T_y(C_1) + g_1C_1 - T_x(C_2) - (f_1 - g_2)C_2 \right) \\
      &= \frac 1 {f_2} \left( T_y(C_1) + g_1C_1 - C_5 - (f_1 - g_2)C_2 \right)
\end{align*}
\begin{align*}
  a_3    &= \frac 1 {f_2} \left(     - g_0a_6 - h_0a_{11} + g_1a_1    - a_5    - (f_1 - g_2)a_2    \right) \\
  a_8    &= \frac 1 {f_2} \left(              - h_1a_{11}             - a_{10} - (f_1 - g_2)a_7    \right) \\
  a_{13} &= \frac 1 {f_2} \left( a_1 - g_2a_6 - (h_2 - g_1)a_{11}     - a_{15} - (f_1 - g_2)a_{12} \right) .
\end{align*}

\note{39M}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%                      %%%%%
%%%%%   Computing Kernel   %%%%%
%%%%%                      %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Computing Kernel}

Let
\[ M =
\begin{pmatrix}
  a_1 & a_2 & a_3 & a_4 & a_5 \\
  a_6 & a_7 & a_8 & a_9 & a_{10} \\
  a_{11} & a_{12} & a_{13} & a_{14} & a_{15}
\end{pmatrix}. \]
We compute the row echelon form of $M$,
\[ M' =
\begin{pmatrix}
  a_1 & a_2 & a_3 & a_4 & a_5 \\
    0 & b_1 & b_2 & b_3 & b_4 \\
    0 &   0 & c_1 & c_2 & c_3
\end{pmatrix}. \]
\begin{align*}
  d_1 &= a_1a_{12} - a_2a_{11} & b_1 &= a_1a_7    - a_2a_6 & c_1 &= b_1a_{13} - d_1a_8    + d_2a_3 \\
  d_2 &= a_6a_{12} - a_7a_{11} & b_2 &= a_1a_8    - a_3a_6 & c_2 &= b_1a_{14} - d_1a_9    + d_2a_4 \\
      &                        & b_3 &= a_1a_9    - a_4a_6 & c_3 &= b_1a_{15} - d_1a_{10} + d_2a_5 \\
      &                        & b_4 &= a_1a_{10} - a_5a_6
\end{align*}

\[ M'' =
\begin{pmatrix}
  Z & 0 & 0 & A_1 & A_2 \\
  0 & Z & 0 & B_1 & B_2 \\
  0 & 0 & Z & C_1 & C_2
\end{pmatrix}. \]
\begin{align*}
  Y &= a_1b_1 & e_1 &= b_3c_1 - b_2c_2 \\
  Z &= Yc_1   & e_2 &= b_4c_1 - b_2c_3
\end{align*}
\begin{align*}
  A_1 &= b_1(a_4c_1 - c_2a_3) - a_2e_1 & B_1 &= a_1e_1 & C_1 &= Yc_2 \\
  A_2 &= b_1(a_5c_1 - c_3a_3) - a_2e_2 & B_2 &= a_1e_2 & C_2 &= Yc_3
\end{align*}

\begin{align*}
  U1 &= Zf_0 - C_1h_1 - B_1g_1 - A_1f_1 & V1 &= Zg_0 - C_2h_1 - B_2g_1 - A_2f_1 \\
  U2 &=      - C_1h_2 - B_1g_2 - A_1f_2 & V2 &=      - C_2h_2 - B_2g_2 - A_2f_2 \\
  U3 &= Zf_1 - A_1 & V3 &= Zg_1 - A_2 \\
  U4 &= Zf_2 - B_1 & V4 &= Zg_2 - B_2 \\
  U5 &=      - C_1 & V5 &=      - C_2
\end{align*}


\subsection{Reducing}
